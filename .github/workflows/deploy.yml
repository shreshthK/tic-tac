# GitHub Actions CI/CD Workflow for Tic-Tac-Toe
# Deploys to AWS EC2 using SSM (recommended) or SSH

name: Build and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

env:
  NODE_VERSION: "22"
  PNPM_VERSION: "9.14.2"

jobs:
  # ===========================================
  # Build and Test Job
  # ===========================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linting
        run: pnpm lint
        continue-on-error: true # Don't fail build on lint warnings

      - name: Run type checking
        run: pnpm run build
        # This builds all packages which includes type checking

      - name: Run tests
        run: pnpm test
        continue-on-error: true # Remove this once tests are set up

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            apps/backend/dist
            apps/frontend/dist
            packages/shared/dist
          retention-days: 1

  # ===========================================
  # Deploy Job - SSM Method (Recommended)
  # ===========================================
  deploy-ssm:
    name: Deploy via SSM
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    # Only deploy on push to main, not on PRs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify SSM agent connectivity
        run: |
          echo "Checking SSM agent status on EC2 instance..."
          aws ssm describe-instance-information \
            --filters "Key=InstanceIds,Values=${{ secrets.EC2_INSTANCE_ID }}" \
            --query "InstanceInformationList[0].PingStatus" \
            --output text

      - name: Deploy to EC2 via SSM
        id: deploy
        run: |
          echo "Sending deployment command to EC2..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "GitHub Actions deployment - ${{ github.sha }}" \
            --parameters 'commands=[
              "cd /home/ubuntu/tic-tac-toe",
              "echo \"Starting deployment at $(date)\"",
              "echo \"Commit: ${{ github.sha }}\"",
              "git fetch origin main",
              "git reset --hard origin/main",
              "docker-compose down",
              "docker-compose build --no-cache",
              "docker-compose up -d",
              "echo \"Waiting for containers to be healthy...\"",
              "sleep 10",
              "docker-compose ps",
              "echo \"Deployment completed at $(date)\""
            ]' \
            --timeout-seconds 600 \
            --query "Command.CommandId" \
            --output text)

          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "Deployment command sent. Command ID: $COMMAND_ID"

      - name: Wait for deployment to complete
        run: |
          echo "Waiting for deployment command to complete..."
          aws ssm wait command-executed \
            --command-id "${{ steps.deploy.outputs.command_id }}" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            || true  # Don't fail if wait times out, we'll check status

      - name: Check deployment status
        run: |
          STATUS=$(aws ssm get-command-invocation \
            --command-id "${{ steps.deploy.outputs.command_id }}" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --query "Status" \
            --output text)

          echo "Deployment status: $STATUS"

          if [ "$STATUS" != "Success" ]; then
            echo "Deployment failed! Fetching output..."
            aws ssm get-command-invocation \
              --command-id "${{ steps.deploy.outputs.command_id }}" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --query "StandardOutputContent" \
              --output text

            echo "Error output:"
            aws ssm get-command-invocation \
              --command-id "${{ steps.deploy.outputs.command_id }}" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --query "StandardErrorContent" \
              --output text

            exit 1
          fi

          echo "Deployment successful!"

      - name: Health check
        run: |
          echo "Performing health check..."
          # Wait a bit for services to fully start
          sleep 5

          # Get the public IP and check health
          # Note: Replace with actual health check URL if you have an Elastic IP
          echo "Health check completed (manual verification recommended)"

  # ===========================================
  # Deploy Job - SSH Method (Alternative)
  # ===========================================
  # Uncomment this job and comment out deploy-ssm if using SSH method
  #
  # deploy-ssh:
  #   name: Deploy via SSH
  #   runs-on: ubuntu-latest
  #   needs: build
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Setup SSH key
  #       run: |
  #         mkdir -p ~/.ssh
  #         echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
  #         chmod 600 ~/.ssh/deploy_key
  #         ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
  #
  #     - name: Deploy to EC2
  #       run: |
  #         ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'DEPLOY_SCRIPT'
  #           set -e
  #           cd /home/ubuntu/tic-tac-toe
  #           echo "Starting deployment at $(date)"
  #
  #           # Pull latest code
  #           git fetch origin main
  #           git reset --hard origin/main
  #
  #           # Rebuild and restart containers
  #           docker-compose down
  #           docker-compose build --no-cache
  #           docker-compose up -d
  #
  #           # Wait for containers to be healthy
  #           sleep 10
  #           docker-compose ps
  #
  #           echo "Deployment completed at $(date)"
  #         DEPLOY_SCRIPT
  #
  #     - name: Cleanup SSH key
  #       if: always()
  #       run: rm -f ~/.ssh/deploy_key

  # ===========================================
  # Rollback Job (Manual Trigger Only)
  # ===========================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    # This job only runs on manual trigger

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Rollback to previous version
        run: |
          echo "Initiating rollback..."
          aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "GitHub Actions rollback" \
            --parameters 'commands=[
              "cd /home/ubuntu/tic-tac-toe",
              "echo \"Starting rollback at $(date)\"",
              "git log --oneline -5",
              "git reset --hard HEAD~1",
              "docker-compose down",
              "docker-compose build --no-cache",
              "docker-compose up -d",
              "sleep 10",
              "docker-compose ps",
              "echo \"Rollback completed at $(date)\""
            ]' \
            --timeout-seconds 600

          echo "Rollback initiated. Check AWS SSM console for status."

  # ===========================================
  # Notification Job (Optional)
  # ===========================================
  # notify:
  #   name: Send Notification
  #   runs-on: ubuntu-latest
  #   needs: [deploy-ssm]
  #   if: always()
  #
  #   steps:
  #     - name: Send Slack notification
  #       uses: 8398a7/action-slack@v3
  #       with:
  #         status: ${{ job.status }}
  #         fields: repo,message,commit,author,action,eventName,ref,workflow
  #       env:
  #         SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
